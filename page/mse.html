<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mse</title>
</head>
<body>
    <div class="video-box">
        <video controls id="mse-video" src="" ></video>
    </div>
    <script src="https://gpac.github.io/mp4box.js/dist/mp4box.all.js"></script>
    <script> 
        function getMimeType (buffer) {
            return new Promise((resolve, reject) => {
                const mp4boxfile = MP4Box.createFile();
            
                mp4boxfile.onReady = (info) => {
                    console.log('mp4box onReady info', info)
                    mp4boxfile.onSegment = function (id, user, buffer, sampleNumber, last) {
                        console.log('onSegment', id, user, buffer, sampleNumber, last)
                    }
                    var initSegs = mp4boxfile.initializeSegmentation();  
                    mp4boxfile.start();
                    resolve(info.mime)
                };
                mp4boxfile.onError = () => reject();
            
                (buffer).fileStart = 0;
                mp4boxfile.appendBuffer(buffer);
            });
        }


        var video = document.querySelector('#mse-video');
        // var mineCodes = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
        // var mineCodes = 'video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.5';
        var mineCodes = 'video/mp4; codecs="hvc1.1.6.L120.90, mp4a.40.2'; // hvc1.1.6.L120.90,mp4a.40.2

        if (window.MediaSource && MediaSource.isTypeSupported(mineCodes)) { 
            console.log('support')
            // 检测当前环境是否支持 MediaSource API以及是否支持此mineCodes
            var mediaSource = new MediaSource();
            // 使用 mediaSource对象创建blob url，并赋给video.src
            video.src = URL.createObjectURL(mediaSource);
            mediaSource.addEventListener('sourceopen', sourceOpen); 
        } else {
            console.log("The Media Source Extensions API is not supported.")
        }

        function sourceOpen(e) {
            console.log('sourceOpen', e.target)
            // URL.revokeObjectURL 主动释放引用
            URL.revokeObjectURL(video.src);

            var mediaSource = e.target;
            // addSourceBuffer根据传入的mineCodes，创建一个新的 SourceBuffer 并添加到 MediaSource 的 SourceBuffers 列表
            var sourceBuffer = mediaSource.addSourceBuffer(mineCodes); 
            // var videoUrl = 'http://vwxcj.weishi.qq.com/vwxcj.weishi.qq.com/gzc_5622_1047_0bc3dmabwaaahaalyfrh6bsbogyedmnqag2a.f61.mp4?dis_k=1a912444c9ddcb9605ef65c24a3e959e&dis_t=1681437739&fromtag=0&personid=h5&pver=8.92.0&wsadapt=h5_0414100219__193424055_0_0_0_27_26_0_0_0_0_0&qua=';
            var videoUrl = 'http://sqimg.qq.com/qq_product_operations/test/mov_bbb.mp4'
            fetch(videoUrl)
                .then(function(response) {
                    console.log('fetch response', response)
                    return response.arrayBuffer();
                })
                .then(async function(arrayBuffer) {
                    sourceBuffer.addEventListener('updateend', function(e) {
                        console.log('sourceBuffer updateend', sourceBuffer.updating, mediaSource.readyState)
                        if (!sourceBuffer.updating && mediaSource.readyState === 'open') {
                            console.warn('endStream')
                            // 数据添加完毕后，调用endOfStream结束当前流
                            mediaSource.endOfStream(); 
                        }
                    });
                    sourceBuffer.addEventListener('error', function(e){
                        console.log('sourceBuffer error', e)
                    })
                    console.log('arrayBuffer', arrayBuffer);
                    const mime = await getMimeType(arrayBuffer);
                    console.log('mime', mime)
                    // 将媒体数据添加到sourceBuffer中
                    sourceBuffer.appendBuffer(arrayBuffer); 

                   
                });
        }
    </script>
</body>
</html>