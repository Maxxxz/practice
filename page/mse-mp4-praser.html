<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-itunes-app" content="app-id=444934666">
	<meta name="format-detection" content="telephone=no">
    <title></title>
    <style type="text/css">
    	/*手QH5页面通用css基础样式*/
    	html,body, div, p, ol, ul, li, table, tbody, tr, td, textarea,
        form, input, h1, h2, h3, h4, h5, dl, dt, dd, img, iframe, header, nav,
        section, article, footer, figure, figcaption, menu, a, p,button {padding: 0;margin: 0; -webkit-user-select: none; -moz-user-select: none; -webkit-text-size-adjust: none;-webkit-touch-callout: none;}
        html ,body{ width: 100%; height: 100%;}
        body { font-size: 62.5%; font: 16px "Helvetica Neue", Helvetica, STHeiTi, "\5FAE\8F6F\96C5\9ED1", sans-serif; min-width: 320px; margin: 0 auto;}
        em{ font-style: normal;}
        a, span { text-decoration: none;display: inline-block;}
        a:link, a:visited{ color: #fff; text-decoration:none;}
        a,button{outline: none; -webkit-tap-highlight-color:rgba(0,0,0,0);}
        button{border:none; background: transparent;}
        li {list-style: none;}
        /*业务侧css样式*/
    </style>	  
</head>
<body>
    <video controls id="j-video" x-webkit-airplay="true" webkit-playsinline="true" preload="auto" style="width:100%;margin-top:50px;"></video>
    <div id="pros0" style="width:100%;margin-top:30px;">视频加载进度：</div>
    <button id="btn" onclick="play()" style="margin-top:20px;font-size:24px;color:blueviolet;">点我播放</button>
    <div id="noTips"></div>
    <!--业务js脚步区域-->
    <script src="http://sqimg.qq.com/qq_product_operations/test/mp4box.all.js"></script>
    <script type="text/javascript" src="/js/iso_boxer.js"></script>
    <script type="text/javascript">
            var video = document.getElementById('j-video');
            var sourceBufferArr =[];
            // var assetURL = 'http://vwxcj.weishi.qq.com/vwxcj.weishi.qq.com/gzc_9433_1047_0bc3wqdrmaahwealnjtzdfsbbnaec22aofsa.f64.mp4?dis_k=dd9ac08bfed6786816be7fd417ed3551&dis_t=1687314091&fromtag=0&personid=h5&pver=1.0.0&wsadapt=h5_0621102131__196466735_0_0_0_27_31_0_0_0_0_0&qua=';
            // var assetURL = 'http://127.0.0.1:2233/assets/demo_dashinit.mp4';
            var assetURL = 'http://127.0.0.1:2233/assets/265.f70.mp4';
            //http加载模块
            function fetchAB(url) {
                return new Promise((reslove)=>{
                    var xhr = new XMLHttpRequest()
                    xhr.open('GET', url)

                    xhr.setRequestHeader('Range', `bytes=${0}-${ 10 * 1024 * 1024}`)
                    xhr.responseType = 'arraybuffer';
                    xhr.onload = function(res) {
                        console.log('onload', xhr.response)
                        reslove(xhr.response)
                    }
                    xhr.onerror = function() {}
                    xhr.onprogress = function (event) {
                        // console.log('onprogress event', event)
                        // console.log('onprogress xhr.response', xhr.response)
                        // if(xhr.response){
                        //     console.log('stop', xhr.response)
                        //     // reslove(xhr.response)
                        //     // xhr.abort()
                        // }
                    }
                    xhr.send();
                })
            };

            
            class MsePlayer {
                constructor(url){
                    this.mediaSource = null;
                    this.sourceBuffer = null;
                    this.video = document.getElementById('j-video');
                    this.downLoadRange = 1024 * 1024 * 1; // 分段大小
                    this.mp4box = null;
                    this.url = url;
                    this.mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

                    this.init();
                }

                init(){
                    this.initMediaSource();
                }

                initMediaSource(){
                    //关联MSE到video
                    if(window.MediaSource){
                        this.mediaSource = new MediaSource();
                        console.log('initMediaSource', this.mediaSource);
                        this.video.src = window.URL.createObjectURL(this.mediaSource); 
                        // 这一步应该mp4box处理了
                        this.mediaSource.addEventListener('sourceopen', this.sourceOpen);
                    }else{
                        console.error('不支持MediaSource');
                    }
                }
                
                // 支持mediasource的，开始拉取数据
                sourceOpen = (...args) => {
                    console.log('sourceOpen', ...args)

                    this.fetachData();
                }

                play(){
                    console.log('do play')
                    this.video.currentTime = 0;
                    this.video.play()
                }

                async fetachData(){
                    const initData = await fetchAB(this.url);
                    console.log('fetachData initData', initData);
                    console.log('new Int8Array(initData)', new Int8Array(initData))
                    var parsedFile = ISOBoxer.parseBuffer(initData);
                    console.log('parsedFile',  parsedFile);
                    var stcos      = parsedFile.fetchAll('stco');   
                    console.log('stcos',  stcos);
                    stcos.forEach(stco => {
                        const res = ReadBig32(stco._data, 0)
                        console.log('res', res)
                    });
                    // console.log('utf8ToByteArray', ISOBoxer.Utils.utf8ToByteArray(stcos[0]._raw));
                }
            }   


            function ReadBig32(array, index) {
                return ((array[index] << 24) |
                    (array[index + 1] << 16) |
                    (array[index + 2] << 8) |
                    (array[index + 3]));
            }


            const player = new MsePlayer(assetURL);
            function play(){
                player.play();
            }
	</script>
</body>
</html>