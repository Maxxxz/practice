<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-itunes-app" content="app-id=444934666">
	<meta name="format-detection" content="telephone=no">
    <title></title>
    <style type="text/css">
    	/*手QH5页面通用css基础样式*/
    	html,body, div, p, ol, ul, li, table, tbody, tr, td, textarea,
        form, input, h1, h2, h3, h4, h5, dl, dt, dd, img, iframe, header, nav,
        section, article, footer, figure, figcaption, menu, a, p,button {padding: 0;margin: 0; -webkit-user-select: none; -moz-user-select: none; -webkit-text-size-adjust: none;-webkit-touch-callout: none;}
        html ,body{ width: 100%; height: 100%;}
        body { font-size: 62.5%; font: 16px "Helvetica Neue", Helvetica, STHeiTi, "\5FAE\8F6F\96C5\9ED1", sans-serif; min-width: 320px; margin: 0 auto;}
        em{ font-style: normal;}
        a, span { text-decoration: none;display: inline-block;}
        a:link, a:visited{ color: #fff; text-decoration:none;}
        a,button{outline: none; -webkit-tap-highlight-color:rgba(0,0,0,0);}
        button{border:none; background: transparent;}
        li {list-style: none;}
        /*业务侧css样式*/
    </style>	  
</head>
<body>
    <video controls id="j-video" x-webkit-airplay="true" webkit-playsinline="true" preload="auto" style="width:100%;margin-top:50px;"></video>
    <div id="pros0" style="width:100%;margin-top:30px;">视频加载进度：</div>
    <button id="btn" onclick="play()" style="margin-top:20px;font-size:24px;color:blueviolet;">点我播放</button>
    <div id="noTips"></div>
    <!--业务js脚步区域-->
    <script src="http://sqimg.qq.com/qq_product_operations/test/mp4box.all.js"></script>
    <script type="text/javascript">
            var video = document.getElementById('j-video');
            var sourceBufferArr =[];
            // var assetURL = 'http://vwxcj.weishi.qq.com/vwxcj.weishi.qq.com/gzc_9433_1047_0bc3wqdrmaahwealnjtzdfsbbnaec22aofsa.f64.mp4?dis_k=dd9ac08bfed6786816be7fd417ed3551&dis_t=1687314091&fromtag=0&personid=h5&pver=1.0.0&wsadapt=h5_0621102131__196466735_0_0_0_27_31_0_0_0_0_0&qua=';
            // var assetURL = 'http://127.0.0.1:2233/assets/demo_dashinit.mp4';
            var assetURL = 'http://127.0.0.1:2233/assets/demo.mp4';
            //http加载模块
            function fetchAB(url) {
                // return fetch(url, {
                //     // headers: { Range: `bytes=${0}-${ 1 * 1024 * 1024}` },
                // })
                // .then(async (res) => {
                //     // const [, , end, total] = res.headers.get('Content-Range')?.match(/(\d+)-(\d+)\/(\d+)/);
                //     // console.log('end, total', end, total)
                //     console.log('fetchAB res', res);
                //     const buffer = await res.arrayBuffer();
                //     console.log('fetch buffer', buffer)
                //     return buffer;
                // })

                return new Promise((reslove)=>{
                    var xhr = new XMLHttpRequest()
                    xhr.open('GET', url)

                    xhr.setRequestHeader('Range', `bytes=${0}-${ 0.5 * 1024 * 1024}`)
                    xhr.responseType = 'arraybuffer';
                    xhr.onload = function(res) {
                        console.log('onload', xhr.response)
                        reslove(xhr.response)
                    }
                    xhr.onerror = function() {}
                    function updateProgress (event) {
                        console.log('onprogress', event, xhr.response)
                    }
                    xhr.onprogress = updateProgress; //下载的progress事件
                    xhr.send();
                })

            };

            
            class MsePlayer {
                constructor(url){
                    this.mediaSource = null;
                    this.sourceBuffer = null;
                    this.video = document.getElementById('j-video');
                    this.downLoadRange = 1024 * 1024 * 1; // 分段大小
                    this.mp4box = null;
                    this.url = url;
                    this.mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

                    this.init();
                }

                init(){
                    this.initMediaSource();
                }

                initMp4box(){
                    this.mp4box  = new MP4Box();
                    this.mp4box.onMoovStart = function (info) {
                        console.log("mp4box Starting to receive File Information", info);
                    }
                    this.mp4box.onReady = this.mp4boxReady  //  callback is called when the the 'moov' box has been parse
                    this.mp4box.onSegment = this.mp4boxOnSegment
                    this.mp4box.onSamples = function (id, user, samples) {
                        console.log('onSamples', id, user, samples)
                    }
                }

                mp4boxReady = (info)=>{
                    console.log("mp4box onReady info", info)
                    this.mediaSource.duration = Math.floor(info.duration / 1000);
                    console.log('getInfo', this.mp4box.getInfo())
                    for (var i = 0; i < info.tracks.length; i++) {
                        var track = info.tracks[i];
                        this.setSegmentByTrack(track)
                    }
                    // console.log('onReady sourceBufferArr', sourceBufferArr)
                    var initSegs = this.mp4box.initializeSegmentation();
                    console.log('initSegs', initSegs);
                    let pendingInits = 0
                    for (var i = 0; i < initSegs.length; i++) {
                        var sourceBuffer = initSegs[i].user;
                        sourceBuffer.addEventListener("updateend", (e)  => {
                            // console.log('updateend', this.video);
                            pendingInits--;
                            if (pendingInits === 0) {
                                this.mp4box.start();
                            }
                            this.updateFunct(e)
                        });
                        console.log('initSegs[i].buffer', initSegs[i].buffer )
                        sourceBuffer.appendBuffer(initSegs[i].buffer);
                        pendingInits++;
                    }
                }

                setSegmentByTrack(track){
                    var mime = 'video/mp4; codecs=\"' + track.codec + '\"';
                    console.log('setSegmentByTrack mime', mime)
                    console.log('setSegmentByTrack track.type id', track.type, track.id)
                    if (MediaSource.isTypeSupported(mime)) {  //  && track.type=='video'
                        try{
                            var sourceBuffer = this.mediaSource.addSourceBuffer(mime);
                            console.log('setSegmentByTrack addSourceBuffer sourceBuffer', sourceBuffer)
  
                            this.mp4box.setSegmentOptions(
                                track.id, 
                                sourceBuffer, 
                                { nbSamples: track.nb_samples }
                            ); 
                        }catch(e){
                            console.error('no support mse', mime)
                            console.error(e)
                        }
                    }
                }

                mp4boxOnSegment = (id, sourceBuffer, arraryBuffer, sampleNum) =>{
                    //生成一个片都会触发一次
                    // console.log('>>>'+id+'>>>'+sampleNum);
                    console.log('mp4boxOnSegment sourceBuffer', sourceBuffer, arraryBuffer)
                    console.log('mp4boxOnSegment arraryBuffer', arraryBuffer)
                    sourceBuffer.appendBuffer(arraryBuffer);
                }

                initMediaSource(){
                    //关联MSE到video
                    if(window.MediaSource){
                        this.mediaSource = new MediaSource();
                        console.log('initMediaSource', this.mediaSource);
                        this.video.src = window.URL.createObjectURL(this.mediaSource); 
                        // 这一步应该mp4box处理了
                        this.mediaSource.addEventListener('sourceopen', this.sourceOpen);
                    }else{
                        console.error('不支持MediaSource');
                    }
                }
                
                // 支持mediasource的，开始拉取数据
                sourceOpen = (...args) => {
                    console.log('sourceOpen', ...args)
                    this.initMp4box();
                    this.fetachData();
                }

                updateFunct = async () => {
                    console.log('updateFunct', this.video.buffered.length)
                    if (this.video.buffered.length) {
                         // 视频开始能播放后，监听视频的timeupdate来决定是否继续请求数据
                        // this.sourceBuffer.removeEventListener("updateend", this.updateFunct);
                        // this.bindVideoEvent();
                    } else {
                        console.log('need load more')
                        // // 继续加载初始化数据，直到视频能够播放，才能触发timeupdate事件
                        // const initRange = this.calculateRange();
                        // const initData = await this.fetchVideo(initRange);
                        // // 更新下载的当前片段，方便计算下一次拉取
                        // this.updateSegmentStart(initRange);

                        // this.sourceBuffer.appendBuffer(initData);
                    }
                }

                play(){
                    console.log('do play')
                    this.video.currentTime = 0;
                    this.video.play()
                }

                async fetachData(){
                    const initData = await fetchAB(this.url);
                    console.log('fetachData initData', initData, new Int8Array(initData))
                    initData.fileStart = 0; // fileStart value of the next buffer. This is particularly useful when the moov box is not at the beginning of the file.
                    var nextBufferStart = this.mp4box.appendBuffer(initData);
                    console.log('fetachData nextBufferStart', nextBufferStart)
                    // this.mp4box.flush();
                }
            }   

            const player = new MsePlayer(assetURL);
            function play(){
                player.play();
            }
	</script>
</body>
</html>