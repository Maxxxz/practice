<!--
 * @Author: maxizhang
 * @Date: 2021-09-06 20:32:41
 * @FilePath: /practice/assemblyScript/index.html
 * @Description: 11
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=`, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/@assemblyscript/loader/umd/index.js"></script>
    <script>

        const global = {
            imports: {
                imported_func: function(arg) {
                console.log(arg);
                }
            },
            env: {
                abort: () => {},
            },
        };
        
        fetch('./build/untouched.wasm').then(response => {
            console.log('response', response);
            return response.arrayBuffer();
        }).then(bytes => {
            
            console.log('bytes', bytes)
            return loader.instantiate(
                // Binary to instantiate
                bytes, // or fs.readFileSync
            )
            // return WebAssembly.instantiate(bytes, global)
        }).then(result => {
            console.log('result', result)
            console.log('result.exports.__new', result.exports.__new)
            console.log('result.exports.__setArgumentsLength', result.exports.__setArgumentsLength)
            
            testStr(result)
            testClass(result)
            
        });

        function testStr(myModule){
            const { goconcat } = myModule.exports
            const { __newString, __getString } = myModule.exports
            function doConcat(aStr, bStr) {
                let aPtr = __newString(aStr)
                console.log('aPtr', aPtr)
                let bPtr = __newString(bStr)
                let cPtr = goconcat(aPtr, bPtr)
                console.log('cPtr', cPtr)
                let cStr = __getString(cPtr)
                return cStr
            }

            console.log(doConcat("Hello ", "world!"))
        }

        function testClass(myModule){
            // JavaScript
            const { Foo, getFoo } = myModule.exports
            const { __getString, __pin, __unpin } = myModule.exports
            console.log('__pin, __unpin', __pin, __unpin)
            const test1 = getFoo();
            console.log('test1', test1)
            const fooPtr = __pin(test1) // pin if necessary
            console.log('fooPtr', fooPtr)
            const foo = Foo.wrap(fooPtr)
            console.log('foo', foo)
            const strPtr = foo.getString()
            console.log('strPtr', strPtr)
            console.log(__getString(strPtr))
            const unp = __unpin(fooPtr) // unpin if necessary
            console.log('unp',  unp)
        }
    </script>
</body>
</html>