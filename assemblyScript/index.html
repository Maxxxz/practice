<!--
 * @Author: maxizhang
 * @Date: 2021-09-06 20:32:41
 * @FilePath: /practice/assemblyScript/index.html
 * @Description: 11
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=`, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/@assemblyscript/loader/umd/index.js"></script>
    <script>

        const global = {
            imports: {
                imported_func: function(arg) {
                console.log(arg);
                }
            },
            env: {
                abort: () => {},
            },
        };
        fetch('./build/untouched.wasm').then(response => {
            console.log('response', response);
            return response.arrayBuffer();
        }).then(bytes => {
            
            console.log('bytes', bytes)
            return loader.instantiate(
                // Binary to instantiate
                bytes, // or fs.readFileSync
            )
            // return WebAssembly.instantiate(bytes, global)
        }).then(result => {
            console.log('result', result)

            const { goconcat } = result.instance.exports
            const { __newString, __getString } = result.exports
            function doConcat(aStr, bStr) {
                let aPtr = __newString(aStr)
                let bPtr = __newString(bStr)
                let cPtr = goconcat(aPtr, bPtr)
                let cStr = __getString(cPtr)
                return cStr
            }

            console.log(doConcat("Hello ", "world!"))
        });
        
    </script>
</body>
</html>